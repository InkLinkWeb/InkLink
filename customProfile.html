<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="/InkLink/img/inkLinkLogo.png">
    <title>Profile</title>
    <style>
      /* Animation for the welcome message */
      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }
      .fade-out {
        animation: fadeOut 2s forwards;
      }
    </style>
  </head>

  <body class="bg-[#F2F2F2] min-h-screen">
    <nav id="navbar" class="bg-[#181818] w-full sticky top-0 z-50">
      <div class="mx-auto max-w-7xl px-2 sm:px-6 lg:px-8">
        <div class="relative flex h-16 items-center justify-between">
          <div class="flex flex-1 items-center justify-center sm:items-stretch sm:justify-start">
            <div class="flex shrink-0 items-center">
              <a href="index.html" class="flex items-center space-x-2">
                <img class="h-12 w-auto" src="/InkLink/img/inkLinkLogo.png" alt="Ink Link Logo">
            </a>
            </div>
            <div class="hidden sm:ml-6 sm:block">
              <div class="flex space-x-4">
                <a href="gallery.html" class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Explore</a>
                <a href="Chat.html" class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Chat</a>
                <a href="map_page.html" class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Map</a>
                <a href="testingpost.html" class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Upload</a>
              </div>
            </div>
          </div>
          <div class="absolute inset-y-0 right-0 flex items-center pr-2 sm:static sm:inset-auto sm:ml-6 sm:pr-0">
            <div class="relative ml-3">
              <div>
                <button type="button" class="relative flex rounded-full bg-gray-800 text-sm focus:ring-2 focus:ring-[#8758FF] focus:ring-offset-2 focus:ring-offset-gray-800 focus:outline-hidden z-60" data-dropdown-toggle="user-menu" id="user-menu-button" aria-expanded="true" aria-haspopup="true">
                  <span class="absolute -inset-1.5"></span>
                  <span class="sr-only">Open user menu</span>
                  <img class="h-12 w-12 object-fit-cover rounded-full" src="/InkLink/img/inkLinkLogo.png" alt="temp image">
                </button>
              </div>
              <div class="absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-md bg-white py-1 ring-1 shadow-lg ring-black/5 focus:outline-hidden hidden" id="user-menu" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" tabindex="-1">
                <a href="/InkLink/customProfile.html" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1">Your Profile</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1">Settings</a>
                <a href="#" id="signout-button" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1">Sign out</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main content wrapper -->
  <div id="main-content" class="flex items-center justify-center min-h-screen">
    <!-- Welcome Message -->
    <div id="welcome-container" class="max-w-md w-full bg-white rounded-lg shadow-lg p-8 text-center">
      <h1 id="welcome-message" class="text-2xl font-bold mb-4"></h1>
      <p class="text-gray-600">Redirecting to your profile...</p>
    </div>
    <!-- Profile Page -->
    <div id="profile-container" class="hidden max-w-4xl w-full bg-white rounded-lg shadow-lg p-8">
      <div class="flex items-center space-x-6">
        <img
          id="profile-picture"
          class="h-24 w-24 rounded-full object-cover border border-gray-300"
          src=""
          alt="Profile Picture"
        />
        <div>
          <h1 id="profile-name" class="text-3xl font-bold"></h1>
          <p id="profile-bio" class="text-gray-600">This is your bio. Click edit to update it!</p>
        </div>
      </div>
        <button
          id="edit-profile-btn"
          class="mt-4 px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600 transition">
            Edit Profile
        </button>
    
          <!-- Sign out button -->
          <button
            id="signout-button"
            class="mt-4 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition"
          >
            Sign Out
          </button>
    
          <!-- Edit Profile Form -->
          <form id="edit-profile-form" class="hidden mt-6 space-y-4">
            <div>
              <label for="edit-name" class="block text-sm font-medium">Name</label>
              <input
                type="text"
                id="edit-name"
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
            <div>
              <label for="edit-bio" class="block text-sm font-medium">Bio</label>
              <textarea
                id="edit-bio"
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring focus:ring-blue-200"
              ></textarea>
            </div>
            <div>
              <label for="edit-picture" class="block text-sm font-medium">Profile Picture</label>
              <input
                type="file"
                id="edit-picture"
                accept="image/*"
                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
            <button
              type="submit"
              class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition"
            >
              Save Changes
            </button>
          </form>
        </div>
  </div>


    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
      import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCJJatBLi5cR_GRhbsHQ5SdzlAW3bOswzU",
        authDomain: "inklinkweb.firebaseapp.com",
        projectId: "inklinkweb",
        storageBucket: "inklinkweb.firebasestorage.app",
        messagingSenderId: "932046606000",
        appId: "1:932046606000:web:bae7db8b2929df69413575"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // Redirect to login page if not logged in
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "index.html"; // Redirect to login page if not logged in
        }
      });

      // Add event listener to the sign-out button
      document.getElementById("signout-button").addEventListener("click", async () => {
        const confirmSignOut = confirm("Are you sure you want to sign out?");
        if (confirmSignOut) {
          try {
            await signOut(auth);
            window.location.href = "index.html";
          } catch (error) {
            console.error("Error signing out:", error);
            alert("An error occurred while signing out. Please try again.");
          }
        }
      });

      // Extract the user's name from the query parameters
      const params = new URLSearchParams(window.location.search);
      const name = params.get("name") || "User";

      // Simulate fetching the user's profile picture and bio (replace with actual logic)
      const defaultProfilePictureUrl = "/img/default-profile.png";

      // Display the welcome message
      const welcomeMessage = document.getElementById("welcome-message");
      welcomeMessage.textContent = `Welcome, ${name}!`;

      // After 2 seconds, animate the welcome message away and show the profile page
      setTimeout(() => {
        document.getElementById("welcome-container").classList.add("fade-out");
        setTimeout(() => {
          document.getElementById("welcome-container").classList.add("hidden");
          const profileContainer = document.getElementById("profile-container");
          profileContainer.classList.remove("hidden");

          // Populate the profile page with the user's data
          onAuthStateChanged(auth, async (user) => {
            if (user) {
              const userDoc = doc(db, "users", user.uid);
              const userSnapshot = await getDoc(userDoc);

              if (userSnapshot.exists()) {
                const userData = userSnapshot.data();
                console.log("User Data:", userData);
                // Access fields like userData.name, userData.bio, userData.profilePicture
                document.getElementById("profile-name").textContent = userData.name || name;
                document.getElementById("profile-bio").textContent = userData.bio || "This is your bio. Click edit to update it!";
                document.getElementById("profile-picture").src = userData.profilePicture || defaultProfilePictureUrl;
              } else {
                console.log("No such user document!");
              }
            }
          });
        }, 2000); // Match the animation duration
      }, 2000);

      // Handle Edit Profile button click
      document.getElementById("edit-profile-btn").addEventListener("click", () => {
        document.getElementById("edit-profile-form").classList.toggle("hidden");
      });

      // Handle Edit Profile form submission
      document.getElementById("edit-profile-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        // Get updated values
        const updatedName = document.getElementById("edit-name").value;
        const updatedBio = document.getElementById("edit-bio").value;
        const updatedPicture = document.getElementById("edit-picture").files[0];

        // Get the current user
        const user = auth.currentUser;
        if (!user) {
          alert("You must be logged in to edit your profile.");
          return;
        }

        // Save updated data to Firestore
        const userDoc = doc(db, "users", user.uid);
        const updatedData = {
          name: updatedName,
          bio: updatedBio,
        };

        if (updatedPicture) {
          // Upload the profile picture to Firebase Storage (optional)
          const reader = new FileReader();
          reader.onload = async (e) => {
            updatedData.profilePicture = e.target.result;

            // Save to Firestore
            await setDoc(userDoc, updatedData, { merge: true });

            // Update the profile page
            document.getElementById("profile-name").textContent = updatedName;
            document.getElementById("profile-bio").textContent = updatedBio;
            document.getElementById("profile-picture").src = e.target.result;

            // Hide the form
            document.getElementById("edit-profile-form").classList.add("hidden");
          };
          reader.readAsDataURL(updatedPicture);
        } else {
          // Save to Firestore without a new picture
          await setDoc(userDoc, updatedData, { merge: true });

          // Update the profile page
          document.getElementById("profile-name").textContent = updatedName;
          document.getElementById("profile-bio").textContent = updatedBio;

          // Hide the form
          document.getElementById("edit-profile-form").classList.add("hidden");
        }
      });
    </script>
    <script type="module" src="./scripts/navbarHandler.js"></script>
  </body>
</html>